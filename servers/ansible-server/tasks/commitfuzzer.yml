---
- hosts: all
  vars_files:
    - ../variables.yml

  tasks:
  - name: Remove Fuzzer directory if it exists
    become: true
    file:
      state: absent
      path: "{{fuzzer_folder}}"

  - name: Create fuzzer directory
    become: true
    file:
      path: "{{fuzzer_folder}}"
      state: directory 
  
  - name: Copy files into fuzzer directory
    become: true
    template:
      src: "{{item}}"
      dest: "{{fuzzer_folder}}"
      force: yes
    with_items:
      - /ansible-server/templates/package.json
      - /ansible-server/templates/fuzzer.js
      - /ansible-server/templates/initiateFuzzer.js

  - name: Remove prior directory if it exists
    become: true
    file:
      state: absent
      path: "{{prior_folder}}"

  - name: Create prior directory
    become: true
    file:
      path: "{{prior_folder}}"
      state: directory 
  
  - name: Copy files into prior directory
    become: true
    template:
      src: "{{item}}"
      dest: "{{prior_folder}}"
      force: yes
    with_items:
      - /ansible-server/templates/test-suites/testPrior.js
      - /ansible-server/templates/test-suites/package.json

  - name: Create testReport dir inside prior
    become: true
    file:
      path: "{{testReport_folder}}"
      state: directory 

  - name: Install shelljs npm package
    npm:
      name: "{{item}}"
      path: "{{fuzzer_folder}}"
      state: present
    become: true
    with_items: 
      - shelljs
      - path

  - name: Git Config
    become: true
    shell: "git config --global user.email \"devops@ncsu.com\" && git config --global user.name \"milestone2\""
         

  - name: Start the Commit Fuzzer
    become: true
    shell: 'node initiateFuzzer.js; sleep 15'
    args:
      chdir: "{{fuzzer_folder}}"
    with_sequence: "count=3"
---
- hosts: all
  vars_files:
    - ../variables.yml

  tasks:
  - name: Install esprima 
    become: true
    command: npm install esprima@4.0
    args: 
     chdir: "{{checkbox_folder}}"  
  
  - name: Remove build.txt file if it exists in checkbox folder
    become: true
    file:
      state: absent
      path: "{{checkbox_folder}}/build.txt"

  - name: Copy analysis file to checkbox folder
    become: true
    copy:
      src: "/ansible-server/templates/checkboxanalysis.js"
      dest: "{{checkbox_folder}}"
      force: yes  
    
  - name: Run checkbox analysis for the first three tasks
    become: true
    command: node checkboxanalysis.js
    args:
     chdir: "{{checkbox_folder}}" 
    register: shell_result
    
  - debug:
     var: shell_result.stdout_lines  

  - name: Check if build.txt exists in checkbox folder
    stat:
      path: "{{checkbox_folder}}/build.txt"
    register: checkbox_build   

  - name: Copy build.txt to checkbox job folder if it exists
    become: true
    copy:
      src: "{{checkbox_folder}}/build.txt"
      dest: "/var/lib/jenkins/workspace"
      force: yes  
    when: checkbox_build.stat.exists == true   

  - name: Update jenkins job
    become: true
    command: "jenkins-jobs update jobs"  
    args:
      chdir: /home/vagrant

# AST tree diff 
  # - name: Install Gradle
  #   become: true
  #   npm:
  #    name: gradle
  #    version: 1.0.9
  #    global: yes

  # - name: Check for cloned Gumtree repo
  #   stat:
  #     path: "{{gumtree_folder}}"
  #   register: gumtree_repo   

  # - name: Clone GumTree as AST difference tool
  #   become: true
  #   git:
  #     repo: https://github.com/GumTreeDiff/gumtree.git
  #     dest: "{{gumtree_folder}}"
  #   when: gumtree_repo.stat.isdir is not defined
     

  # - name: Build GumTree
  #   become: true
  #   command: ./gradlew build -x test
  #   args:
  #     chdir: "{{gumtree_folder}}" 
   

  # - name: Check for zip folder of GumTree
  #   become: true
  #   stat: path="{{gumtree_folder}}/dist/build/distributions/gumtree-2.1.3-SNAPSHOT.zip"  
  #   register: build_gumtree

  # - name: Unzip GumTree
  #   become: true
  #   command: "unzip {{gumtree_folder}}/dist/build/distributions/gumtree-2.1.3-SNAPSHOT.zip"
  #   args:
  #     chdir: "{{gumtree_folder}}/dist/build/distributions"
  #   when: build_gumtree.stat.exists == True  

  # - name: Check for gumtree folder in checkbox
  #   become: true
  #   stat: path="{{checkbox_folder}}/gumtree-2.1.3-SNAPSHOT"
  #   register: gumtree_file

  # - name: Move Gumtree zip folder to checkbox
  #   become: true
  #   command: "mv {{gumtree_folder}}/dist/build/distributions/gumtree-2.1.3-SNAPSHOT {{checkbox_folder}}"   
  #   when: gumtree_file.stat.exists == False    
